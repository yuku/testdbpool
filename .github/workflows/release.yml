name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Run tests
      env:
        PGHOST: localhost
        PGPORT: 5432
        PGUSER: postgres
        PGPASSWORD: postgres
        PGSSLMODE: disable
      run: |
        # Start PostgreSQL for tests
        docker run -d \
          --name postgres \
          -e POSTGRES_USER=postgres \
          -e POSTGRES_PASSWORD=postgres \
          -e POSTGRES_DB=postgres \
          -p 5432:5432 \
          postgres:16
        
        # Wait for PostgreSQL to be ready
        for i in {1..30}; do
          if docker exec postgres pg_isready -U postgres; then
            break
          fi
          echo "Waiting for PostgreSQL..."
          sleep 1
        done
        
        # Run tests
        go test -v ./...

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true
        draft: false
        prerelease: false